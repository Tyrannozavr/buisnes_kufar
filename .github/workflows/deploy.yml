name: Deploy to production

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # –°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          echo "Host target-server" >> ~/.ssh/config
          echo "  HostName ${{ secrets.SERVER_IP }}" >> ~/.ssh/config
          echo "  User root" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_ed25519" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Deploy with validation
        run: |
          ssh target-server "
            set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
            cd buisnes_kufar && \
            
            # 1. –ü–æ–ª—É—á–∞–µ–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            git fetch origin
            if git diff --quiet HEAD origin/master; then
              echo '‚úÖ –ù–µ—Ç –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. –í—ã—Ö–æ–¥–∏–º.'
              exit 0
            fi
            git reset --hard origin/master
            
            # 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –Ω–æ–≤—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
            docker compose up -d --build --force-recreate && \
            
            # 3. –î–∞—ë–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–ø—É—Å–∫ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            sleep 15 && \
            
            # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –û–°–ù–û–í–ù–´–ï –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            REQUIRED_CONTAINERS='backend frontend nginx'
            if docker compose ps --status running | grep -qE \"(${REQUIRED_CONTAINERS// /|})\"; then
              echo '‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã! –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã.'
            else
              echo '‚ùå –û—à–∏–±–∫–∞: –Ω–µ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å! –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º...'
              git reset --hard HEAD^
              docker compose down
              docker compose up -d  # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é
              exit 1
            fi
          "

      - name: Clean up old images
        run: |
          ssh target-server "
            # –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤
            echo 'üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö Docker –æ–±—Ä–∞–∑–æ–≤...'
            docker image prune -af
            echo '‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.'
          "