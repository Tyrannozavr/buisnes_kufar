name: Deploy to production

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSH (Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ)
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "${{ secrets.SERVER_IP }} ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkm5YLr4GqQd6k1P1n1uUVUjOZiVXyZpeYzi2NABqXZNZg8X1u8uW2/2QY=" >> ~/.ssh/known_hosts
          echo "Host target-server" > ~/.ssh/config
          echo "  HostName ${{ secrets.SERVER_IP }}" >> ~/.ssh/config
          echo "  User root" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_ed25519" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: Check for changes
        id: check-changes
        run: |
          changes=$(ssh target-server "cd buisnes_kufar && git fetch origin && git diff --name-only HEAD origin/master")
          if [ -z "$changes" ]; then
            echo "::set-output name=has_changes::false"
            echo "âœ… No changes detected"
          else
            echo "::set-output name=has_changes::true"
            echo "ðŸ”´ Changes detected:"
            echo "$changes"
          fi

      - name: Deploy application
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          ssh target-server << 'EOF'
          set -e
          cd buisnes_kufar
          
          # Create rollback point
          current_commit=$(git rev-parse HEAD)
          echo "Rollback point: $current_commit"
          
          # Apply changes
          git reset --hard origin/master
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð¾Ð² (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚)
          [ -f "./backend/.env" ] || cp ./backend/.env.example ./backend/.env
          [ -f "./frontend/.env" ] || cp ./frontend/.env.example ./frontend/.env
          
          # ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´ÐµÐ¿Ð»Ð¾Ñ (ÐºÐ°Ðº Ð²Ñ‹ Ð´ÐµÐ»Ð°ÐµÑ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ)
          echo "ðŸš€ Starting deployment with nginx..."
          if docker compose up -d --build nginx; then
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ nginx
            for i in {1..5}; do
              if docker compose ps nginx | grep -q "Up"; then
                echo "âœ… Nginx is running"
                break
              else
                if [ $i -eq 5 ]; then
                  echo "âŒ Nginx failed to start after 5 attempts"
                  docker compose logs nginx
                  exit 1
                fi
                sleep 5
              fi
            done
          else
            echo "âŒ Deployment failed! Rolling back..."
            git reset --hard $current_commit
            docker compose up -d nginx
            exit 1
          fi
          EOF

      - name: Cleanup (weekly)
        if: github.event.schedule == '0 0 * * 1'  # ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 00:00
        run: |
          ssh target-server "docker system prune -af --filter 'until=168h'"  # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² ÑÑ‚Ð°Ñ€ÑˆÐµ 1 Ð½ÐµÐ´ÐµÐ»Ð¸