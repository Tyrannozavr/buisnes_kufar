name: Deploy to production

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: 1  # –í–∫–ª—é—á–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ª–æ—ë–≤

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          cat <<EOF >> ~/.ssh/config
          Host target-server
            HostName ${{ secrets.SERVER_IP }}
            User root
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking no
          EOF

      - name: Pre-cache Docker images
        run: |
          ssh target-server "
            echo 'üîπ –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑—ã –≤ –∫—ç—à...'
            docker pull nginx:1.25 || true
            docker pull python:3.12-slim || true
            docker pull node:20-slim || true
          "

      - name: Deploy with validation
        run: |
          ssh target-server "
            set -e
            cd buisnes_kufar
            git fetch origin

            if git diff --quiet HEAD origin/master; then
              echo '‚úÖ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π.'
              exit 0
            fi

            current_commit=\$(git rev-parse HEAD)
            git reset --hard origin/master

            if docker compose build --pull && docker compose up -d --force-recreate; then
              sleep 15
              for container in backend frontend nginx; do
                if ! docker compose ps --status running | grep -q \$container; then
                  echo \"‚ùå \$container –Ω–µ –∑–∞–ø—É—â–µ–Ω! –õ–æ–≥–∏:\"
                  docker compose logs \$container
                  exit 1
                fi
              done
              echo '‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–µ–Ω!'
            else
              echo '‚ùå –û—à–∏–±–∫–∞! –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è...'
              git reset --hard \$current_commit
              docker compose down
              docker compose up -d
              exit