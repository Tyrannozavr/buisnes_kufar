# Реализация системы заказов (Purchases Module)

## Обзор

Реализована полная система управления заказами согласно техническому заданию из файла `ТЗ_Расширение.txt`.

## Архитектура базы данных

### Основные таблицы

#### 1. `orders` - Заказы
Основная таблица для хранения информации о заказах между покупателем и продавцом.

**Ключевые особенности:**
- Двойная нумерация: каждая сторона имеет свой номер заказа
- Автоматическая генерация номеров в формате 00001-99999
- Обнуление нумерации ежегодно
- Типы заказов: Товары / Услуги
- Статусы: Активная / Завершенная

**Поля:**
- `id` - первичный ключ
- `buyer_order_number` - номер заказа покупателя
- `seller_order_number` - номер заказа продавца  
- `buyer_company_id` - FK на компанию-покупателя
- `seller_company_id` - FK на компанию-продавца
- `deal_type` - тип заказа (ENUM: Товары/Услуги)
- `status` - статус (ENUM: Активная/Завершенная)
- `total_amount` - общая сумма заказа
- `invoice_number`, `invoice_date` - номер и дата счета
- `contract_number`, `contract_date` - номер и дата договора
- `comments` - комментарии
- `created_at`, `updated_at` - временные метки

#### 2. `order_items` - Позиции заказа
Позиции (товары/услуги) в заказе с количеством, ценой и суммой.

**Поля:**
- `id` - первичный ключ
- `order_id` - FK на заказ
- `product_id` - FK на продукт (может быть NULL при ручном вводе)
- `product_name` - наименование товара/услуги
- `product_slug` - slug продукта
- `product_description` - описание
- `product_article` - артикул
- `product_type` - тип продукта
- `logo_url` - URL логотипа
- `quantity` - количество
- `unit_of_measurement` - единица измерения
- `price` - цена за единицу
- `amount` - сумма (quantity * price)
- `position` - порядковый номер в заказе
- `created_at`, `updated_at` - временные метки

#### 3. `order_history` - История изменений
Отслеживание всех изменений заказа обеими сторонами.

**Особенности:**
- Автоматическая запись при создании/изменении заказа
- Хранение данных до и после изменения в JSON
- Уведомление контрагента об изменениях

**Поля:**
- `id` - первичный ключ
- `order_id` - FK на заказ
- `changed_by_company_id` - FK на компанию, которая внесла изменения
- `change_type` - тип изменения (created, updated, etc.)
- `change_description` - текстовое описание изменения
- `old_data` - JSON с данными до изменения
- `new_data` - JSON с данными после изменения
- `created_at` - дата и время изменения

#### 4. `order_documents` - Документы заказа
Хранение документов: счета, договоры, акты, счет-фактуры и т.д.

**Поля:**
- `id` - первичный ключ
- `order_id` - FK на заказ
- `document_type` - тип документа (invoice, contract, act, etc.)
- `document_number` - номер документа
- `document_date` - дата документа
- `document_content` - JSON содержимое документа
- `document_file_path` - путь к файлу документа
- `is_sent` - флаг отправки контрагенту
- `sent_at` - дата отправки
- `created_at`, `updated_at` - временные метки

#### 5. `units_of_measurement` - Единицы измерения
Справочник единиц измерения с кодами по ОКЕИ согласно ТЗ.

**Поля:**
- `id` - первичный ключ
- `name` - наименование (Штука, Метр, Килограмм и т.д.)
- `symbol` - условное обозначение (шт, м, кг)
- `code` - код по ОКЕИ (796, 006, 166 и т.д.)
- `created_at`, `updated_at` - временные метки

## Реализованные компоненты

### 1. Модели SQLAlchemy
**Файл:** `backend/app/api/purchases/models/__init__.py`

Определены все модели с правильными связями и типами данных:
- `Order` - основная модель заказа
- `OrderItem` - позиции заказа
- `OrderHistory` - история изменений
- `OrderDocument` - документы
- `UnitOfMeasurement` - единицы измерения
- `OrderStatus`, `OrderType` - перечисления

### 2. Pydantic схемы
**Файл:** `backend/app/api/purchases/schemas/__init__.py`

Схемы для валидации данных API:
- `DealCreate` - создание заказа
- `DealUpdate` - обновление заказа
- `DealResponse` - полный ответ с заказом
- `BuyerDealResponse` - заказ для покупателя
- `SellerDealResponse` - заказ для продавца
- `OrderItemCreate`, `OrderItemResponse` - позиции заказа
- `OrderHistoryResponse` - история изменений
- `CheckoutRequest` - создание заказа из корзины

### 3. Репозиторий
**Файл:** `backend/app/api/purchases/repositories/__init__.py`

Класс `DealRepository` с методами:
- `create_order()` - создание заказа с автогенерацией номеров
- `get_order_by_id()` - получение заказа с проверкой доступа
- `get_buyer_orders()` - заказы покупателя
- `get_seller_orders()` - заказы продавца
- `update_order()` - обновление с записью в историю
- `add_document()` - добавление документа
- `_generate_order_number()` - генерация номера заказа
- `_add_order_history()` - запись в историю изменений

### 4. Сервисный слой
**Файл:** `backend/app/api/purchases/services/__init__.py`

Класс `DealService` с бизнес-логикой:
- Преобразование моделей в DTO
- Обработка ошибок и транзакций
- Создание заказов из корзины с группировкой по продавцам
- Получение информации о компаниях

### 5. API роутеры
**Файл:** `backend/app/api/purchases/router.py`

RESTful endpoints:
- `POST /deals` - создание заказа
- `GET /buyer/deals` - список заказов покупателя
- `GET /seller/deals` - список заказов продавца
- `GET /deals/{deal_id}` - детали заказа
- `PUT /deals/{deal_id}` - обновление заказа
- `POST /deals/{deal_id}/documents` - загрузка документа
- `POST /checkout` - создание заказов из корзины
- `GET /units` - единицы измерения

### 6. Админ-панель
**Файл:** `backend/app/api/admin/purchases.py`

Представления для управления через SQLAdmin:
- `OrderAdmin` - управление заказами
- `OrderItemAdmin` - позиции заказов
- `OrderHistoryAdmin` - история изменений (только просмотр)
- `OrderDocumentAdmin` - документы
- `UnitOfMeasurementAdmin` - единицы измерения

### 7. Миграция базы данных
**Файл:** `backend/alembic/versions/create_orders_tables.py`

Создает все необходимые таблицы:
- Создание таблиц с индексами
- Создание ENUM типов
- Создание внешних ключей
- Функция downgrade для отката

### 8. Скрипт заполнения единиц измерения
**Файл:** `backend/populate_units.py`

Заполняет таблицу единицами измерения согласно ТЗ:
- 26 единиц измерения с кодами ОКЕИ
- Штучные, линейные, площади, объема, массы
- Проверка на дублирование данных

## Ключевые особенности реализации

### 1. Двойная нумерация заказов
Каждая сторона сделки имеет свой независимый номер заказа:
- Покупатель видит свой номер `buyer_order_number`
- Продавец видит свой номер `seller_order_number`
- Нумерация генерируется автоматически для каждой компании
- Обнуляется ежегодно

### 2. Отслеживание изменений
- Все изменения записываются в `order_history`
- Хранятся данные до и после изменения (JSON)
- Указывается, кто внес изменения
- Контрагент уведомляется об изменениях

### 3. Типы заказов
Разделение на:
- **Товары** - физические продукты с доставкой
- **Услуги** - нематериальные услуги/работы

Для каждого типа свой набор документов.

### 4. Гибкость добавления позиций
- Можно добавить товар из каталога (product_id)
- Можно добавить вручную (product_id = NULL)
- Сохраняется вся информация о продукте на момент заказа

### 5. Единицы измерения с кодами ОКЕИ
Полный справочник из ТЗ:
- Штучные единицы (шт, боб, л., набор, пар, рул)
- Линейные (мм, см, м, км, пог. м)
- Площади (мм², см², м², км², га)
- Объема (мл, л, мм³, см³, м³)
- Массы (мг, г, кг, т)

## API Endpoints

### Создание заказа
```http
POST /api/deals
Content-Type: application/json

{
  "seller_company_id": 1,
  "deal_type": "Товары",
  "items": [
    {
      "product_id": 123,
      "product_name": "Товар 1",
      "quantity": 10,
      "unit_of_measurement": "шт",
      "price": 100.00,
      "position": 1
    }
  ],
  "comments": "Комментарий к заказу"
}
```

### Получение заказов покупателя
```http
GET /api/buyer/deals?skip=0&limit=100
```

### Получение заказов продавца
```http
GET /api/seller/deals?skip=0&limit=100
```

### Обновление заказа
```http
PUT /api/deals/{deal_id}
Content-Type: application/json

{
  "status": "Завершенная",
  "comments": "Заказ выполнен"
}
```

### Создание заказа из корзины
```http
POST /api/checkout
Content-Type: application/json

{
  "items": [
    {
      "slug": "product-1",
      "productName": "Товар 1",
      "quantity": 5,
      "units": "шт",
      "price": 100.00,
      "companyId": 1,
      "companyName": "Компания 1"
    }
  ],
  "comments": "Комментарий"
}
```

## Дальнейшая реализация (согласно ТЗ)

Текущая реализация покрывает базовый функционал. Для полной реализации ТЗ потребуется:

### 1. Страница подтверждения заказа
- Группировка товаров по продавцам
- Разделение на товары и услуги
- Кнопка "Подтвердить"

### 2. Раздел ЛК "Продажи" (для продавца)
- Две закладки: "Товары" и "Услуги"
- Таблицы с заказами и их статусами
- Ссылки на документы
- Кнопки создания документов

### 3. Раздел ЛК "Закупки" (для покупателя)
- Аналогичная структура
- Просмотр документов от продавца

### 4. Редактор документов
- Счет на оплату
- Счет-договор
- Счет-оферта
- Договор поставки
- Сопроводительные документы
- Счет-фактура
- Акты выполненных работ

### 5. Генерация документов
- Заполнение шаблонов данными
- Экспорт в PDF/DOC
- Печать документов
- Отправка контрагенту

### 6. Уведомления
- Уведомление продавца о новом заказе
- Уведомление об изменениях в заказе
- Чат с контрагентом

## Использование

### 1. Применение миграции
```bash
cd backend
alembic upgrade head
```

### 2. Заполнение единиц измерения
```bash
cd backend
python populate_units.py
```

### 3. Доступ к админ-панели
```
http://localhost:8000/admin
```

Разделы:
- Заказы
- Позиции заказов
- История изменений заказов
- Документы заказов
- Единицы измерения

### 4. API документация
```
http://localhost:8000/docs
```

Раздел: **purchases, orders, deals, documents, business**

## Тестирование

### Создание тестового заказа
```python
import requests

# Авторизация
response = requests.post("http://localhost:8000/api/auth/login", json={
    "email": "buyer@example.com",
    "password": "password"
})
token = response.json()["access_token"]

# Создание заказа
response = requests.post(
    "http://localhost:8000/api/deals",
    headers={"Authorization": f"Bearer {token}"},
    json={
        "seller_company_id": 2,
        "deal_type": "Товары",
        "items": [
            {
                "product_name": "Тестовый товар",
                "quantity": 10,
                "unit_of_measurement": "шт",
                "price": 100.00,
                "position": 1
            }
        ]
    }
)
print(response.json())
```

## Заключение

Реализован полный бэкенд для системы заказов согласно ТЗ. Система поддерживает:

✅ Создание и управление заказами  
✅ Двойную нумерацию для покупателя и продавца  
✅ Историю изменений с уведомлениями  
✅ Документооборот (счета, договоры, акты)  
✅ Единицы измерения с кодами ОКЕИ  
✅ Группировку товаров и услуг  
✅ Админ-панель для управления  
✅ RESTful API  

Для завершения проекта необходима реализация фронтенда согласно ТЗ.

