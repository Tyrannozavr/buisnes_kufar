# Бриф по косякам/рискам в ветке `Sapach` (для Сергея Сапача)

Дата: 2026-01-25  
Контекст: ревью изменений ветки `Sapach` относительно `master` + фиксы, необходимые чтобы проект стабильно запускался в dev.

## TL;DR
- **Главные блокеры**: закоммиченные TLS-ключи/серты, конфликт-маркеры в `nginx/nginx.local.conf`, хардкод dev-адресов/портов.
- **Главные риски**: нарушение контракта `create_deal`, тяжёлые клиентские зависимости без явного client-only, TypeScript-код в `public/`, demo-данные в сторах.
- **Что сделано для запуска dev**: вынесены порты/URL/CORS в `.env`, nginx dev переведён на `8080`, устранён merge-конфликт в `nginx.local.conf`, перестали коммититься `.env` и dev TLS-файлы.

## Что критично неверно / опасно

### 1) Секреты в репозитории (критично)
- `nginx/letsencrypt/live/localhost/privkey.pem` (приватный ключ) и `fullchain.pem` **были в git**.
- Это означает **компрометацию ключа**: его нужно считать утекшим и **перевыпустить/ротировать**.

Рекомендации:
- Никогда не хранить приватные ключи/сертификаты в git.
- Держать их через volume/секреты/генерацию на машине, а в репо — только инструкции.
- Если ключ уже попал в git-историю — чистить историю (BFG / `git filter-repo`) и ротировать ключи.

### 2) Merge-конфликт закоммичен в nginx-конфиг (блокер запуска)
- В `nginx/nginx.local.conf` были `<<<<<<< / ======= / >>>>>>>`, из‑за чего nginx не стартует.

Рекомендации:
- Любые конфликты должны блокировать PR/merge (обязательные checks).
- Для nginx-конфигов — минимальный e2e smoke-test в CI: `nginx -t`.

### 3) Хардкод dev-адресов/портов и CORS по проекту
Симптомы:
- в compose/nuxt встречались жёстко прошитые `localhost:8000/8001/8002`;
- из‑за этого конфигурация “расползается” по репо и ломается при смене портов/окружения.

Рекомендации:
- Оставлять в git только `.env.example`.
- В dev использовать единый `.env` (локальный, в gitignored), из которого читаются:
  - порты (`DEV_BACKEND_PORT`, `DEV_FRONTEND_PORT`, `DEV_NGINX_PORT`);
  - `BACKEND_CORS_ORIGINS`;
  - `VITE_PUBLIC_API_URL`, `API_BASE_URL`, `NUXT_DEV_API_PROXY_TARGET`.

## Backend: спорные/ошибочные места

### Контракт `create_deal`
Риск:
- Роутер ожидает `None` и отдаёт `400`, а сервис местами переходит на `raise`/`ValueError`.
- Без явного обработчика это превращается в **500** и ломает ожидаемый контракт API.

Рекомендации:
- Единообразно: либо сервис возвращает `DealResponse|None`, либо сервис бросает **доменные исключения**, а роутер/handler превращает их в корректные HTTP 4xx.
- Не бросать “голые” `ValueError` наружу (нужны свои исключения или `HTTPException`).
- `IntegrityError` обрабатывать без парсинга `str(e)` по подстрокам constraint’ов (это хрупко).

### `product_id=0` → `NULL`
Риск:
- “Магическое” поведение на бэкенде маскирует клиентские ошибки.

Рекомендации:
- Валидировать вход: `0` запрещён (422), `null`/отсутствие `product_id` — явный режим “ручной позиции”.

## Frontend: архитектурные косяки/риски

### TypeScript в `public/`
Симптом:
- `frontend/public/templates/*.ts` импортируются как код.

Риски:
- `public/` — зона статики, это плохая структура и может вести к утечкам/неожиданной сборке.

Рекомендации:
- Перенести в `frontend/lib/` или `frontend/utils/` (или `frontend/templates/` вне `public/`).

### PDF/DOCX генерация и client-only
Риски:
- зависимости `html2canvas-pro/jspdf/docx` тяжёлые и должны быть строго client-only;
- есть риск SSR/бандл‑раздувания.

Рекомендации:
- Динамический импорт по кнопке (lazy) и явное `if (import.meta.client)`.
- Аккуратно работать с DOM-клонами (не оставлять в `document.body`).

### Demo-данные в сторах
Риск:
- `examples/exampleStoreData.ts` как источник state выглядит как временное решение, которое легко “протащить” в прод.

Рекомендации:
- Явно разделить mock/dev данные и реальные запросы.
- Сторы должны получать данные с API, а не стартовать с демо-массива.

## Что сделано для запуска dev (чтобы не упираться в занятые порты)
- `docker-compose.dev.yml`: порты/URL/CORS берутся из `.env` с дефолтами; nginx по умолчанию поднимается на `8080`.
- `frontend/nuxt.config.ts`: proxy target для `/api` берётся из `NUXT_DEV_API_PROXY_TARGET`.
- `.env` перестал отслеживаться git (оставлен только `.env.example`).
- dev TLS‑файлы `localhost` перестали отслеживаться git.
- `nginx/nginx.local.conf`: устранены конфликт‑маркеры.

## Авторство / ответственность (важно: есть сомнения)
Ниже — “последний коммит по файлу” (это НЕ всегда означает, что автор реально писал код — часто попадает через merge).

- `restore_on_server.sh`:
  - `git log --follow` показывает изменения от **dmiv** (Сергей в истории — в основном merge).
- `backend/app/api/purchases/services/__init__.py` и `repositories/__init__.py`:
  - последние изменения в этих файлах — **dmiv** (коммит про `product_id=0` и `IntegrityError`).
- `nginx/nginx.local.conf`:
  - исходные правки были от **dmiv**, но в ветку попали merge-коммиты от **Sergey Sapach**.

Если нужно точно определить автора каждой строки — лучше прогнать `git blame` по конкретным проблемным участкам.

