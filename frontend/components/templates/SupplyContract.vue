<script setup lang="ts">
import { TemplateElement } from '~/constants/keys'
import { useRoute } from 'vue-router'
import { usePurchasesStore } from '~/stores/purchases'
import { useSalesStore } from '~/stores/sales'
import { normalizeDate } from '~/utils/normalize'
import { useDocumentForm } from '~/composables/useDocumentForm'
import { computed } from 'vue'

const html = useTemplateRef('html')
const htmlSupplyContract = useTypedState(TemplateElement.SUPPLY_CONTRACT, () => ref(null))
const route = useRoute()
const purchasesStore = usePurchasesStore()
const salesStore = useSalesStore()

const dealId = computed(() => {
	const q = route.query.dealId ?? route.query.deal_id
	return q ? Number(q) : null
})

const initialPayload: Record<string, string> = {
	buyerName: '',
	buyerRepresentative: '',
	supplierName: '',
	contractAmount: '',
	deliveryTerms: '',
	contractSubject: '',
}

const {
	payload,
	loading,
	saving,
	error,
	updatedAt,
	save,
} = useDocumentForm({
	slot: 'supplyContract',
	dealId,
	initialPayload,
})

const supplyContractNumber = computed(() => {
	const q = route.query
	if (!q?.dealId || !q?.role || !q?.productType) return ''
	const dealId = Number(q.dealId)
	if (q.role === 'buyer') {
		const deal = q.productType === 'goods'
			? purchasesStore.findGoodsDeal(dealId)
			: purchasesStore.findGoodsDeal(dealId)
		return deal?.supplyContractNumber ?? ''
	}
	const deal = q.productType === 'goods'
		? salesStore.findGoodsDeal(dealId)
		: salesStore.findGoodsDeal(dealId)
	return deal?.supplyContractNumber ?? ''
})

const supplyContractDateFormatted = computed(() => {
	const q = route.query
	if (!q?.dealId || !q?.role || !q?.productType) return '—'
	const dealId = Number(q.dealId)
	let dateStr = ''
	if (q.role === 'buyer') {
		const deal = q.productType === 'goods'
			? purchasesStore.findGoodsDeal(dealId)
			: purchasesStore.findGoodsDeal(dealId)
		dateStr = deal?.supplyContractDate ?? ''
	} else {
		const deal = q.productType === 'goods'
			? salesStore.findGoodsDeal(dealId)
			: salesStore.findGoodsDeal(dealId)
		dateStr = deal?.supplyContractDate ?? ''
	}
	return dateStr ? normalizeDate(dateStr) : '—'
})

onMounted(() => {
	htmlSupplyContract.value = html.value
})
</script>

<template>
	<div ref="html" class="font-serif text-l text-justify text-pretty w-full">
		<div v-if="error" class="mb-2 text-red-600 text-sm">{{ error }}</div>
		<div v-if="dealId" class="mb-4 flex gap-2 items-center">
			<UButton
				size="sm"
				:loading="saving"
				:disabled="loading"
				@click="save()"
			>
				Сохранить документ
			</UButton>
			<span v-if="updatedAt" class="text-gray-500 text-sm">Сохранено: {{ updatedAt }}</span>
		</div>

		<h1 class="font-bold">Договор поставки № {{ supplyContractNumber || '—' }}</h1><br />

		<p class="text-right">{{ supplyContractDateFormatted }}</p><br />
		<p>{{ payload.buyerName || '{НазваниеКонтр}' }} именуемое в дальнейшем «Покупатель», в лице {{ payload.buyerRepresentative || '{КонтрВЛице}' }}, действующего на основании Устава, с
			одной
			стороны, и ИП {{ payload.supplierName || '{ФИОИП}' }}, именуемый в дальнейшем «Поставщик», с другой стороны, именуемые в дальнейшем Стороны,
			заключили настоящий Договор о нижеследующем:</p>
		<h2>1. Предмет договора</h2>
		<p>1.1. В соответствии с настоящим Договором Поставщик обязуется поставить Покупателю (далее — Продукция) в
			соответствии со Спецификацией (приложение 1 к настоящему Договору), а Покупатель принять и оплатить продукцию в
			соответствии с разделом 2 договора.</p>
		<h2>2. Сумма договора и порядок расчетов</h2>
		<p>2.1. Сумма настоящего Договора составляет , включая НДС .</p>
		<p>2.3. Оплата по настоящему Договору производится путем перечисления денежных средств на расчетный счет Поставщика
			в
			следующем порядке:</p>
		<p>1) авансовый платеж в размере % от общей суммы Договора составляет: , включая НДС осуществляется в
			течение______________________ после заключения Договора/согласования спецификации;</p>
		<p>2) последующая оплата в сумме , включая НДС осуществляется в течение с момента приемки продукции на основании .
		</p>
		<p>2.4. Цена продукции на период действия Договора является фиксированной и пересмотру не подлежит.</p>
		<p>2.5. Стоимость доставки продукции, тары, упаковки и маркировки составляет .</p>
		<h2>3. Условия и сроки поставки</h2>
		<p>3.1. Поставка продукции производится в соответствии со Спецификацией (приложение 1 к настоящему Договору).</p>
		<p>3.2. Поставщик обязуется поставить Покупателю продукцию в течение .</p>
		<p>3.3. С каждым комплектом продукции поставляется: .</p>
		<p>3.4. Упаковка продукции должна обеспечивать ее сохранность при транспортировке и хранении.</p>
		<p>3.5. Грузополучателем продукции является Покупатель.</p>
		<p>3.6. Продукция доставляется Поставщиком на склад Получателя .</p>
		<h2>4. Обязательства сторон</h2>
		<p>4.1. Поставщик обязуется:</p>
		<p>4.1.1. Поставить продукцию в соответствии с условиями настоящего Договора.</p>
		<p>4.1.2. В письменной форме известить Покупателя (Грузополучателя) о готовности продукции к отгрузке не позднее,
			чем
			за до поставки.</p>
		<p>4.1.3. Поставщик гарантирует соответствие поставляемой продукции техническим условиям/иным требованиям при ее
			использовании и хранении и несет все расходы по замене или ремонту дефектной продукции, выявленной Покупателем в
			течение гарантийного срока, если дефект не зависит от условий хранения или неправильного обращения.</p>
		<p>4.1.4. Поставщик обязуется обеспечить гарантийное обслуживание поставляемой продукции в течение c момента приемки
			продукции.</p>
		<p>4.2. Покупатель обязуется:</p>
		<p>4.2.1. Принять и оплатить продукцию в соответствии с условиями настоящего Договора.</p>
		<p>4.3. Поставщик по согласованию с Покупателем имеет право на досрочную поставку продукции.</p>
		<p>4.4. Стороны не вправе передавать свои права и обязательства по настоящему Договору третьей стороне без
			письменного
			согласия другой Стороны.</p>
		<h2>5. Порядок приемки продукции</h2>
		<p>5.1. Порядок приемки продукции Покупателем по количеству и качеству регулируется действующими Инструкциями о
			порядке приемки продукции производственно-технического назначения и товаров народного потребления по количеству,
			утвержденной Постановлением Госарбитража при Совете Министров СССР от 15.06.1965 N П-6, о порядке приемки
			продукции
			производственно-технического назначения и товаров народного потребления по качеству, утвержденной Постановлением
			Госарбитража при Совете Министров СССР от 25.04.1966 N П-7.</p>
		<p>5.2. Датой поставки продукции считается дата подписания Сторонами (или их представителями) накладной.</p>
		<h2>6. Ответственность сторон</h2>
		<p>6.1. При нарушении сроков поставки продукции Поставщик, при наличии письменной претензии, уплачивает Покупателю
			пеню в размере % стоимости не поставленной в срок (недопоставленной) продукции за каждый день просрочки, но не
			более
			% указанной стоимости.</p>
		<p>6.2. При несоблюдении предусмотренных настоящим Договором сроков платежей Покупатель, при наличии письменной
			претензии, уплачивает Поставщику пеню в размере _________________________% не перечисленной в срок суммы за каждый
			день просрочки, но не более указанной суммы.</p>
		<p>6.3. Поставщик несет ответственность за качество, комплектацию и количество поставляемой продукции, а также за
			недопоставку продукции.</p>
		<p>6.4. Ответственность Сторон в иных случаях определяется в соответствии с законодательством Российской Федерации.
		</p>
		<p>6.5. Уплата неустойки не освобождает Стороны от исполнения обязательств по настоящему Договору.</p>
		<h2>7. Действие обстоятельств непреодолимой силы</h2>
		<p>7.1. Ни одна из Сторон не несет ответственность перед другой Стороной за неисполнение обязательств по настоящему
			Договору, обусловленное действием обстоятельств непреодолимой силы, т. е. чрезвычайных и непредотвратимых при
			данных
			условиях обстоятельств, в том числе: объявленная или фактическая война, гражданские волнения, эпидемии, блокада,
			эмбарго, пожары, землетрясения, наводнения и другие природные стихийные бедствия, а также издание актов
			государственных органов.</p>
		<p>7.2. Свидетельство, выданное соответствующим компетентным органом, является достаточным подтверждением наличия и
			продолжительности действия непреодолимой силы.</p>
		<p>7.3. Сторона, которая не исполняет обязательств по настоящему Договору вследствие действия непреодолимой силы,
			должна незамедлительно известить другую Сторону о таких обстоятельствах и их влиянии на исполнение обязательств по
			Договору.</p>
		<p>7.4. Если обстоятельства непреодолимой силы действуют на протяжении 3 (трех) последовательных месяцев, настоящий
			Договор может быть расторгнут любой из Сторон путем направления письменного уведомления другой Стороне.</p>
		<h2>8. Порядок разрешения споров</h2>
		<p>8.1. Все споры или разногласия, возникающие между Сторонами по настоящему Договору или в связи с ним, разрешаются
			путем переговоров между ними.</p>
		<p>8.2. В случае невозможности разрешения разногласий путем переговоров они подлежат рассмотрению в арбитражном суде
			согласно порядку, установленному законодательством Российской Федерации.</p>
		<h2>9. Порядок изменения и расторжения договора</h2>
		<p>9.1. Любые изменения и дополнения к настоящему Договору имеют силу только в том случае, если они оформлены в
			письменном виде и подписаны обеими Сторонами.</p>
		<p>9.2. Досрочное расторжение Договора может иметь место в соответствии с п. 7.4 настоящего Договора либо по
			соглашению Сторон, либо на основаниях, предусмотренных законодательством Российской Федерации.</p>
		<p>9.3. Сторона, решившая расторгнуть настоящий Договор, должна направить письменное уведомление о намерении
			расторгнуть настоящий Договор другой Стороне не позднее чем за до предполагаемого дня расторжения настоящего
			Договора.</p>
		<h2>10. Прочие условия</h2>
		<p>10.1. С момента подписания Сторонами настоящего Договора все предыдущие переговоры и переписка по нему теряют
			силу.
		</p>
		<p>10.2. Настоящий Договор вступает в действие с и действует до исполнения Сторонами своих обязательств и завершения
			всех взаиморасчетов по Договору.</p>
		<p>10.3. В случае изменения у какой-либо из Сторон местонахождения, названия, банковских реквизитов и прочего она
			обязана в течение 10 (десяти) дней письменно известить об этом другую Сторону, причем в письме необходимо указать,
			что оно является неотъемлемой частью настоящего Договора.</p>
		<p>10.4. Настоящий Договор составлен в 2 (двух) экземплярах, имеющих одинаковую юридическую силу, по одному для
			каждой
			из сторон.</p>
		<p>10.5. Следующие приложения являются неотъемлемой частью настоящего Договора:</p>
		<p>— приложение 1. Спецификация на поставку продукции.</p>
		<p>10.6. </p>
		<p>10.7. Вопросы, не урегулированные настоящим Договором, разрешаются в соответствии с действующим законодательством
			Российской Федерации.</p>

		<table class=" table-auto">

			<thead>
				<tr>
					<th class="w-1/5">Данные: </th>
					<th class="w-1/5">Заказчик:</th>
					<th class="w-1/5">Исполнитель:</th>
				</tr>
			</thead>

			<tbody>
				<tr>
					<td>Название</td>
					<td>{НазваниеКонтр}</td>
					<td>{ФИОИП}</td>
				</tr>
				<tr>
					<td>ИНН:</td>
					<td>{ИННКонтр}</td>
					<td>{ИНН}</td>
				</tr>
				<tr>
					<td>КПП:</td>
					<td>{КППКонтр}</td>
				</tr>
				<tr>
					<td>ОГРН:</td>
					<td>{ОГРНКонтр}</td>
					<td>ОГРН: {ОГРН}</td>
				</tr>
				<tr>
					<td>Адрес:</td>
					<td>Адрес:{АдресКонтр}</td>
					<td>Адрес: {АдресДляДокументов}</td>
				</tr>
				<tr>
					<td>Р/с:</td>
					<td>{РасчетныйСчетКонтр}</td>
					<td>{РасчетныйСчет}</td>
				</tr>
				<tr>
					<td>Банк:</td>
					<td>{НаименованиеБанкаКонтр}</td>
					<td>Банк:{НаименованиеБанкаИГородБанка}</td>
				</tr>
				<tr>
					<td>БИК:</td>
					<td> {БИКБанкаКонтр}</td>
					<td>БИК: {БИК}</td>
				</tr>
				<tr>
					<td>Корр/с:</td>
					<td> {КоррСчетКонтр}</td>
					<td>Корр/c: {КоррСчет}</td>
				</tr>
				<tr>
					<td>Подписи:</td>
					<td>{ФИОКонтрДляПодписи}</td>
					<td>{ФИОДляПодписи}</td>
				</tr>
				<tr>
					<td>Печати:</td>
					<td>М.П. </td>
					<td>М.П.</td>
				</tr>

			</tbody>

		</table>

	</div>
</template>

<style lang="css" scoped>
* {
	line-height: 1.2em;
}

h1,
h2 {
	text-align: center;
	line-height: 3em;
}

p {
	text-indent: 3em;
	line-height: 1.5em;
}

table,
th,
td {
	border: solid gray 1px;
	padding: 5px;
}
</style>